'use strict';

var g = require('crypto-js');
var Q = require('bn.js');
var M = require('elliptic');

function _interopDefault (e) { return e && e.__esModule ? e : { default: e }; }

var g__default = /*#__PURE__*/_interopDefault(g);
var Q__default = /*#__PURE__*/_interopDefault(Q);
var M__default = /*#__PURE__*/_interopDefault(M);

var Y=Object.defineProperty;var r=(s,e)=>Y(s,"name",{value:e,configurable:!0});var d=new M__default.default.ec("secp256k1"),q=class q{constructor(){this.set_curve=r(()=>{this._curve=this._default_curve;},"set_curve");this.set_curve_by_default=r(()=>{this.set_curve();},"set_curve_by_default");this.curve=r(()=>this._curve,"curve");this._default_curve=new k,this._curve=this._default_curve;}};r(q,"Config");var C=q;function l(){var s=new C;return s.set_curve_by_default(),s.curve()}r(l,"default_curve");var I=class I{constructor(){this._order=d.curve.n;this._generator=d.curve.g;this._order_size=d.curve.n.byteLength();this.name=r(()=>this._name,"name");this.order=r(()=>this._order,"order");this.generator=r(()=>this._generator,"generator");this.order_size=r(()=>this._order_size,"order_size");this._curve=d,this._name="secp256k1",this._order=d.curve.n,this._generator=d.curve.g,this._order_size=d.curve.n.byteLength();}};r(I,"Curve");var k=I;var y=class y{constructor(e){this.curve=r(()=>this._curve,"curve");this.valueOf=r(()=>this._scalar,"valueOf");this.to_bytes=r(()=>{var e=this._scalar.toArray();return e.length==33?e.slice(1,33):e},"to_bytes");this.add=r(e=>new y(this.valueOf().add(e.valueOf())),"add");this.sub=r(e=>new y(this.valueOf().sub(e.valueOf())),"sub");this.mul=r(e=>new y(this.valueOf().mul(e.valueOf()).mod(this.curve().order())),"mul");this.eq=r(e=>this.valueOf().eq(e.valueOf()),"eq");this.invm=r(()=>new y(this.valueOf().invm(this.curve().order())),"invm");this._scalar=e,this._curve=l();}static from_bytes(e){if(e.length!=y.expected_byte_length()&&e.length!=2*this.expected_byte_length())throw new Error("Invalid length of data.");return new y(new Q__default.default(e))}};r(y,"Scalar"),y.generate_random=r(function(){return new y(l()._curve.genKeyPair().getPrivate())},"generate_random"),y.expected_byte_length=r(()=>l().order_size(),"expected_byte_length");var _=y,v=class v{constructor(e){this.to_bytes=r(()=>{var e=this._ec_point.getX().toArray(),t=this._ec_point.getY().toArray();return [4].concat(e,t)},"to_bytes");this.valueOf=r(()=>this._ec_point,"valueOf");this.add=r(e=>new v(this.valueOf().add(e.valueOf())),"add");this.mul=r(e=>new v(this.valueOf().mul(e.valueOf())),"mul");this.eq=r(e=>this.valueOf().eq(e.valueOf()),"eq");this._ec_point=e,this._curve=l();}};r(v,"GroupElement"),v.generate_random=r(()=>new v(l().generator().mul(_.generate_random().valueOf())),"generate_random"),v.from_bytes=r(function(e){var t=v.expected_byte_length();if(e.length!=t)throw new Error("Invalid length of data.");var a=_.expected_byte_length(),n=e.subarray(1,a+1),i=e.subarray(a+1,t);return new v(l()._curve.curve.point(n,i))},"from_bytes"),v.expected_byte_length=r(function(e=!1){return e?1+l().order_size():1+2*l().order_size()},"expected_byte_length");var c=v;var X=class X{constructor(e,t,a,n,i=!1){typeof i=="undefined"&&(i=!1),this._E=e,this._V=t,this._S=a,this._XG=n,this._re_encrypted=i;}get_E(){return this._E}get_V(){return this._V}get_S(){return this._S}get_XG(){return this._XG}set_re_encrypted(){this._re_encrypted=!0;}is_re_encrypted(){return this._re_encrypted}to_bytes(){var e=this.get_E().to_bytes(),t=this.get_V().to_bytes(),a=this.get_S().to_bytes(),n=[];return this.is_re_encrypted()&&this._XG&&(n=this._XG.to_bytes()),e.concat(t,a,n)}static from_bytes(e){var t=_.expected_byte_length(),a=c.expected_byte_length(),n=!1;if(e.length==3*a+t)n=!0;else if(e.length!=2*a+t)throw new Error("Invalid length of data.");var i=c.from_bytes(e.subarray(0,a)),u=c.from_bytes(e.subarray(a,2*a)),m=_.from_bytes(e.subarray(2*a,2*a+t)),h=void 0;return n&&(h=c.from_bytes(e.subarray(2*a+t,3*a+t))),new X(i,u,m,h,n)}};r(X,"Capsule");var w=X;var S=class S{constructor(e){this._scalar=e;let t=new k,a=new O(new c(t.generator().mul(e.valueOf())));this._public_key=a;}valueOf(){return this._scalar}get_public_key(){var e=new k;return new O(new c(e.generator().mul(this.valueOf().valueOf())))}to_bytes(){return this.valueOf().to_bytes()}static generate(e){var a=l()._curve.genKeyPair();return new S(new _(a.getPrivate()))}};r(S,"PrivateKey"),S.from_bytes=r(function(e){return new S(_.from_bytes(e))},"from_bytes");var E=S,A=class A{constructor(e){this.pubKey=e;}valueOf(){return this.pubKey}to_bytes(){return this.valueOf().to_bytes()}static from_bytes(e){return new A(c.from_bytes(e))}};r(A,"PublicKey");var O=A,P=class P{constructor(e,t){this._re_key=e,this._internal_public_key=t;}get_re_key(){return this._re_key}get_internal_public_key(){return this._internal_public_key}to_bytes(){var e=this.get_re_key().to_bytes(),t=this.get_internal_public_key().to_bytes();return e.concat(t)}static from_bytes(e){var t=_.expected_byte_length(),a=c.expected_byte_length();if(e.length!=a+t)throw new Error("Invalid length of data.");var n=_.from_bytes(e.subarray(0,t)),i=c.from_bytes(e.subarray(t,t+a));return new P(n,i)}};r(P,"ReEncryptionKey");var G=P,B=class B{constructor(e,t){this._private_key=e,this._public_key=t;}get_public_key(){return this._public_key}get_private_key(){return this._private_key}static generate_key_pair(){var e=E.generate();return new B(e,e.get_public_key())}static from_private_key(e){let t=new E(new _(new Q__default.default(e.startsWith("0x")?e.slice(2):e,"hex")));return new B(t,t.get_public_key())}};r(B,"KeyPair");var x=B;function b(s){return Array.from(s,e=>("0"+(e&255).toString(16)).slice(-2)).join("")}r(b,"to_hex");function f(s){return Buffer.from(s,"hex")}r(f,"from_hex");function z(s){var e=f(g.SHA256(b(s.to_bytes())).toString());return new _(new Q.BN(e))}r(z,"SHA256");function V(s){var e=f(g.SHA256(b(s[0].to_bytes())).toString()),t=new Q.BN(e),a=new Q.BN(1);return new _(t.add(a))}r(V,"hash_to_scalar");var p=class p{static generate_key_pair(){return x.generate_key_pair()}static generate_re_encryption_key(e,t){var a=this.generate_key_pair(),n=a.get_private_key().valueOf(),i=a.get_public_key().valueOf(),u=t.valueOf(),m=[i,u,u.mul(n)],h=V(m),K=e.valueOf(),D=h.invm(),H=K.mul(D),N=new G(H,i);return N}static decapsulate(e,t){return e.is_re_encrypted()?this.decapsulate_re_encrypted(e,t):this.decapsulate_original(e,t)}static public_key_from_bytes(e){return O.from_bytes(e)}};r(p,"Proxy"),p.encapsulate=r(e=>{var t=p.generate_key_pair(),a=p.generate_key_pair(),n=t.get_private_key().valueOf(),i=a.get_private_key().valueOf(),u=t.get_public_key().valueOf(),m=a.get_public_key().valueOf(),h=[u,m],K=V(h),D=n.add(i.mul(K)),H=e.valueOf(),N=H.mul(n.add(i)),R=z(N),J=new w(u,m,D),W={capsule:J,symmetric_key:R};return W},"encapsulate"),p.decapsulate_original=r(function(e,t){var a=t.valueOf(),n=e.get_E().add(e.get_V()),i=n.mul(a),u=z(i);return u},"decapsulate_original"),p.re_encrypt_capsule=r(function(e,t){var a=e.get_E().mul(t.get_re_key()),n=e.get_V().mul(t.get_re_key()),i=e.get_S();return new w(a,n,i,t.get_internal_public_key(),!0)},"re_encrypt_capsule"),p.decapsulate_re_encrypted=r(function(e,t){var a=e.get_XG(),n=e.get_E(),i=e.get_V(),u=[a,t.get_public_key().valueOf(),a.mul(t.valueOf())],m=V(u),h=n.add(i).mul(m),K=z(h);return K},"decapsulate_re_encrypted"),p.private_key_from_bytes=r(function(e){return E.from_bytes(e)},"private_key_from_bytes"),p.re_encryption_key_from_bytes=r(function(e){return G.from_bytes(e)},"re_encryption_key_from_bytes"),p.capsule_from_bytes=r(function(e){return w.from_bytes(e)},"capsule_from_bytes");var o=p;var L={iv:g__default.default.enc.Utf8.parse("0000000000000000"),mode:g__default.default.mode.CBC,padding:g__default.default.pad.Pkcs7};function Ce(s,e){let t=o.public_key_from_bytes(f(s));var a=o.encapsulate(t),n=b(a.symmetric_key.to_bytes()),i=g__default.default.enc.Utf8.parse(n),u=g__default.default.AES.encrypt(e,i,L);return {key:b(a.capsule.to_bytes()),cipher:u.toString()}}r(Ce,"encryptData");function Xe(s,e){let t=o.private_key_from_bytes(f(s)),a=o.capsule_from_bytes(f(e.key));var n=o.decapsulate(a,t),i=g__default.default.enc.Utf8.parse(b(n.to_bytes())),u=g__default.default.AES.decrypt(e.cipher,i,L).toString(g__default.default.enc.Utf8);return u}r(Xe,"decryptData");function Ae(s,e){let t=o.private_key_from_bytes(f(s)),a=o.public_key_from_bytes(f(e));var n=o.generate_re_encryption_key(t,a);return b(n.to_bytes())}r(Ae,"generateReEncrytionKey");function Pe(s,e){let t=o.re_encryption_key_from_bytes(f(s)),a=o.capsule_from_bytes(f(e.key)),n=o.re_encrypt_capsule(a,t);e.key=b(n.to_bytes());}r(Pe,"reEncryption");

exports.Capsule = w;
exports.Config = C;
exports.Curve = k;
exports.GroupElement = c;
exports.KeyPair = x;
exports.PrivateKey = E;
exports.Proxy = o;
exports.PublicKey = O;
exports.ReEncryptionKey = G;
exports.SHA256 = z;
exports.Scalar = _;
exports.decryptData = Xe;
exports.default_curve = l;
exports.encryptData = Ce;
exports.from_hex = f;
exports.generateReEncrytionKey = Ae;
exports.hash_to_scalar = V;
exports.reEncryption = Pe;
exports.to_hex = b;
