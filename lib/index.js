'use strict';

var E = require('crypto-js');
var F = require('elliptic');
var L = require('bn.js');

function _interopDefault (e) { return e && e.__esModule ? e : { default: e }; }

var E__default = /*#__PURE__*/_interopDefault(E);
var F__default = /*#__PURE__*/_interopDefault(F);
var L__default = /*#__PURE__*/_interopDefault(L);

var U=Object.defineProperty;var t=(i,e)=>U(i,"name",{value:e,configurable:!0});var O=new F__default.default.ec("secp256k1"),B=class{constructor(){this.set_curve=t(()=>{this._curve=this._default_curve;},"set_curve");this.set_curve_by_default=t(()=>{this.set_curve();},"set_curve_by_default");this.curve=t(()=>this._curve,"curve");this._default_curve=new d,this._curve=this._default_curve;}};t(B,"Config");function l(){var i=new B;return i.set_curve_by_default(),i.curve()}t(l,"default_curve");var d=class{constructor(){this._order=O.curve.n;this._generator=O.curve.g;this._order_size=O.curve.n.byteLength();this.name=t(()=>this._name,"name");this.order=t(()=>this._order,"order");this.generator=t(()=>this._generator,"generator");this.order_size=t(()=>this._order_size,"order_size");this._curve=O,this._name="secp256k1",this._order=O.curve.n,this._generator=O.curve.g,this._order_size=O.curve.n.byteLength();}};t(d,"Curve");var y=class{constructor(e){this.curve=t(()=>this._curve,"curve");this.valueOf=t(()=>this._scalar,"valueOf");this.to_bytes=t(()=>{var e=this._scalar.toArray();return e.length==33?e.slice(1,33):e},"to_bytes");this.add=t(e=>new y(this.valueOf().add(e.valueOf())),"add");this.sub=t(e=>new y(this.valueOf().sub(e.valueOf())),"sub");this.mul=t(e=>new y(this.valueOf().mul(e.valueOf()).mod(this.curve().order())),"mul");this.eq=t(e=>this.valueOf().eq(e.valueOf()),"eq");this.invm=t(()=>new y(this.valueOf().invm(this.curve().order())),"invm");this._scalar=e,this._curve=l();}static from_bytes(e){if(e.length!=y.expected_byte_length()&&e.length!=2*this.expected_byte_length())throw new Error("Invalid length of data.");return new y(new L__default.default(e))}},u=y;t(u,"Scalar"),u.generate_random=t(function(){return new y(l()._curve.genKeyPair().getPrivate())},"generate_random"),u.expected_byte_length=t(()=>l().order_size(),"expected_byte_length");var S=class{constructor(e){this.to_bytes=t(()=>{var e=this._ec_point.getX().toArray(),r=this._ec_point.getY().toArray();return [4].concat(e,r)},"to_bytes");this.valueOf=t(()=>this._ec_point,"valueOf");this.add=t(e=>new S(this.valueOf().add(e.valueOf())),"add");this.mul=t(e=>new S(this.valueOf().mul(e.valueOf())),"mul");this.eq=t(e=>this.valueOf().eq(e.valueOf()),"eq");this._ec_point=e,this._curve=l();}},c=S;t(c,"GroupElement"),c.generate_random=t(()=>new S(l().generator().mul(u.generate_random().valueOf())),"generate_random"),c.from_bytes=t(function(e){var r=S.expected_byte_length();if(e.length!=r)throw new Error("Invalid length of data.");var a=u.expected_byte_length(),n=e.slice(1,a+1),_=e.slice(a+1,r);return new S(l()._curve.curve.point(n,_))},"from_bytes"),c.expected_byte_length=t(function(e=!1){return e?1+l().order_size():1+2*l().order_size()},"expected_byte_length");var z=class{constructor(e){this._scalar=e;let r=new d,a=new p(new c(r.generator().mul(e.valueOf())));this._public_key=a;}valueOf(){return this._scalar}get_public_key(){var e=new d;return new p(new c(e.generator().mul(this.valueOf().valueOf())))}to_bytes(){return this.valueOf().to_bytes()}static generate(e){var a=l()._curve.genKeyPair();return new z(new u(a.getPrivate()))}},f=z;t(f,"PrivateKey"),f.from_bytes=t(function(e){return new z(u.from_bytes(e))},"from_bytes");var p=class{constructor(e){this.pubKey=e;}valueOf(){return this.pubKey}to_bytes(){return this.valueOf().to_bytes()}static from_bytes(e){return new p(c.from_bytes(e))}};t(p,"PublicKey");var k=class{constructor(e,r){this._re_key=e,this._internal_public_key=r;}get_re_key(){return this._re_key}get_internal_public_key(){return this._internal_public_key}to_bytes(){var e=this.get_re_key().to_bytes(),r=this.get_internal_public_key().to_bytes();return e.concat(r)}static from_bytes(e){var r=u.expected_byte_length(),a=c.expected_byte_length();if(e.length!=a+r)throw new Error("Invalid length of data.");var n=u.from_bytes(e.slice(0,r)),_=c.from_bytes(e.slice(r,r+a));return new k(n,_)}};t(k,"ReEncryptionKey");var m=class{constructor(e,r){this._private_key=e,this._public_key=r;}get_public_key(){return this._public_key}get_private_key(){return this._private_key}static generate_key_pair(){var e=f.generate();return new m(e,e.get_public_key())}static from_private_key(e){let r=new f(new u(new L__default.default(e.startsWith("0x")?e.slice(2):e,"hex")));return new m(r,r.get_public_key())}};t(m,"KeyPair");var h=class{constructor(e,r,a,n,_=!1){typeof _=="undefined"&&(_=!1),this._E=e,this._V=r,this._S=a,this._XG=n,this._re_encrypted=_;}get_E(){return this._E}get_V(){return this._V}get_S(){return this._S}get_XG(){return this._XG}set_re_encrypted(){this._re_encrypted=!0;}is_re_encrypted(){return this._re_encrypted}to_bytes(){var e=this.get_E().to_bytes(),r=this.get_V().to_bytes(),a=this.get_S().to_bytes(),n=[];return this.is_re_encrypted()&&this._XG&&(n=this._XG.to_bytes()),e.concat(r,a,n)}static from_bytes(e){var r=u.expected_byte_length(),a=c.expected_byte_length(),n=!1;if(e.length==3*a+r)n=!0;else if(e.length!=2*a+r)throw new Error("Invalid length of data.");var _=c.from_bytes(e.slice(0,a)),o=c.from_bytes(e.slice(a,2*a)),g=u.from_bytes(e.slice(2*a,2*a+r)),b=void 0;return n&&(b=c.from_bytes(e.slice(2*a+r,3*a+r))),new h(_,o,g,b,n)}};t(h,"Capsule");function w(i){return Array.from(i,e=>("0"+(e&255).toString(16)).slice(-2)).join("")}t(w,"to_hex");function v(i){return Buffer.from(i,"hex")}t(v,"from_hex");function x(i){var e=v(E.SHA256(w(i.to_bytes())).toString());return new u(new L.BN(e))}t(x,"SHA256");function K(i){var e=v(E.SHA256(w(i[0].to_bytes())).toString()),r=new L.BN(e),a=new L.BN(1);return new u(r.add(a))}t(K,"hash_to_scalar");var V=class{static generate_key_pair(){return m.generate_key_pair()}static generate_re_encryption_key(e,r){var a=this.generate_key_pair(),n=a.get_private_key().valueOf(),_=a.get_public_key().valueOf(),o=r.valueOf(),g=[_,o,o.mul(n)],b=K(g),G=e.valueOf(),X=b.invm(),A=G.mul(X),C=new k(A,_);return C}static decapsulate(e,r){return e.is_re_encrypted()?this.decapsulate_re_encrypted(e,r):this.decapsulate_original(e,r)}static public_key_from_bytes(e){return p.from_bytes(e)}},s=V;t(s,"Proxy"),s.encapsulate=t(e=>{var r=V.generate_key_pair(),a=V.generate_key_pair(),n=r.get_private_key().valueOf(),_=a.get_private_key().valueOf(),o=r.get_public_key().valueOf(),g=a.get_public_key().valueOf(),b=[o,g],G=K(b),X=n.add(_.mul(G)),A=e.valueOf(),C=A.mul(n.add(_)),q=x(C),I=new h(o,g,X),P={capsule:I,symmetric_key:q};return P},"encapsulate"),s.decapsulate_original=t(function(e,r){var a=r.valueOf(),n=e.get_E().add(e.get_V()),_=n.mul(a),o=x(_);return o},"decapsulate_original"),s.re_encrypt_capsule=t(function(e,r){var a=e.get_E().mul(r.get_re_key()),n=e.get_V().mul(r.get_re_key()),_=e.get_S();return new h(a,n,_,r.get_internal_public_key(),!0)},"re_encrypt_capsule"),s.decapsulate_re_encrypted=t(function(e,r){var a=e.get_XG(),n=e.get_E(),_=e.get_V(),o=[a,r.get_public_key().valueOf(),a.mul(r.valueOf())],g=K(o),b=n.add(_).mul(g),G=x(b);return G},"decapsulate_re_encrypted"),s.private_key_from_bytes=t(function(e){return f.from_bytes(e)},"private_key_from_bytes"),s.re_encryption_key_from_bytes=t(function(e){return k.from_bytes(e)},"re_encryption_key_from_bytes"),s.capsule_from_bytes=t(function(e){return h.from_bytes(e)},"capsule_from_bytes");var N={iv:E__default.default.enc.Utf8.parse("0000000000000000"),mode:E__default.default.mode.CBC,padding:E__default.default.pad.Pkcs7};function Se(i,e){let r=s.public_key_from_bytes(v(i));var a=s.encapsulate(r),n=w(a.symmetric_key.to_bytes()),_=E__default.default.enc.Utf8.parse(n),o=E__default.default.AES.encrypt(e,_,N);return {key:w(a.capsule.to_bytes()),cipher:o.toString()}}t(Se,"encryptData");function Ge(i,e){let r=s.private_key_from_bytes(v(i)),a=s.capsule_from_bytes(v(e.key));var n=s.decapsulate(a,r),_=E__default.default.enc.Utf8.parse(w(n.to_bytes())),o=E__default.default.AES.decrypt(e.cipher,_,N).toString(E__default.default.enc.Utf8);return o}t(Ge,"decryptData");function Be(i,e){let r=s.private_key_from_bytes(v(i)),a=s.public_key_from_bytes(v(e));var n=s.generate_re_encryption_key(r,a);return w(n.to_bytes())}t(Be,"generateReEncrytionKey");function xe(i,e){let r=s.re_encryption_key_from_bytes(v(i)),a=s.capsule_from_bytes(v(e.key)),n=s.re_encrypt_capsule(a,r);e.key=w(n.to_bytes());}t(xe,"reEncryption");

exports.Config = B;
exports.Curve = d;
exports.GroupElement = c;
exports.KeyPair = m;
exports.PrivateKey = f;
exports.Proxy = s;
exports.PublicKey = p;
exports.SHA256 = x;
exports.Scalar = u;
exports.decryptData = Ge;
exports.default_curve = l;
exports.encryptData = Se;
exports.from_hex = v;
exports.generateReEncrytionKey = Be;
exports.hash_to_scalar = K;
exports.reEncryption = xe;
exports.to_hex = w;
