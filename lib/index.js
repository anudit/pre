'use strict';

var E = require('crypto-js');
var L = require('bn.js');
var F = require('elliptic');

function _interopDefault (e) { return e && e.__esModule ? e : { default: e }; }

var E__default = /*#__PURE__*/_interopDefault(E);
var L__default = /*#__PURE__*/_interopDefault(L);
var F__default = /*#__PURE__*/_interopDefault(F);

var U=Object.defineProperty;var r=(s,e)=>U(s,"name",{value:e,configurable:!0});var O=new F__default.default.ec("secp256k1"),B=class{constructor(){this.set_curve=r(()=>{this._curve=this._default_curve;},"set_curve");this.set_curve_by_default=r(()=>{this.set_curve();},"set_curve_by_default");this.curve=r(()=>this._curve,"curve");this._default_curve=new k,this._curve=this._default_curve;}};r(B,"Config");function l(){var s=new B;return s.set_curve_by_default(),s.curve()}r(l,"default_curve");var k=class{constructor(){this._order=O.curve.n;this._generator=O.curve.g;this._order_size=O.curve.n.byteLength();this.name=r(()=>this._name,"name");this.order=r(()=>this._order,"order");this.generator=r(()=>this._generator,"generator");this.order_size=r(()=>this._order_size,"order_size");this._curve=O,this._name="secp256k1",this._order=O.curve.n,this._generator=O.curve.g,this._order_size=O.curve.n.byteLength();}};r(k,"Curve");var f=class{constructor(e){this.curve=r(()=>this._curve,"curve");this.valueOf=r(()=>this._scalar,"valueOf");this.to_bytes=r(()=>{var e=this._scalar.toArray();return e.length==33?e.slice(1,33):e},"to_bytes");this.add=r(e=>new f(this.valueOf().add(e.valueOf())),"add");this.sub=r(e=>new f(this.valueOf().sub(e.valueOf())),"sub");this.mul=r(e=>new f(this.valueOf().mul(e.valueOf()).mod(this.curve().order())),"mul");this.eq=r(e=>this.valueOf().eq(e.valueOf()),"eq");this.invm=r(()=>new f(this.valueOf().invm(this.curve().order())),"invm");this._scalar=e,this._curve=l();}static from_bytes(e){if(e.length!=f.expected_byte_length()&&e.length!=2*this.expected_byte_length())throw new Error("Invalid length of data.");return new f(new L__default.default(e))}},u=f;r(u,"Scalar"),u.generate_random=r(function(){return new f(l()._curve.genKeyPair().getPrivate())},"generate_random"),u.expected_byte_length=r(()=>l().order_size(),"expected_byte_length");var S=class{constructor(e){this.to_bytes=r(()=>{var e=this._ec_point.getX().toArray(),t=this._ec_point.getY().toArray();return [4].concat(e,t)},"to_bytes");this.valueOf=r(()=>this._ec_point,"valueOf");this.add=r(e=>new S(this.valueOf().add(e.valueOf())),"add");this.mul=r(e=>new S(this.valueOf().mul(e.valueOf())),"mul");this.eq=r(e=>this.valueOf().eq(e.valueOf()),"eq");this._ec_point=e,this._curve=l();}},c=S;r(c,"GroupElement"),c.generate_random=r(()=>new S(l().generator().mul(u.generate_random().valueOf())),"generate_random"),c.from_bytes=r(function(e){var t=S.expected_byte_length();if(e.length!=t)throw new Error("Invalid length of data.");var a=u.expected_byte_length(),n=e.subarray(1,a+1),_=e.subarray(a+1,t);return new S(l()._curve.curve.point(n,_))},"from_bytes"),c.expected_byte_length=r(function(e=!1){return e?1+l().order_size():1+2*l().order_size()},"expected_byte_length");var p=class{constructor(e,t,a,n,_=!1){typeof _=="undefined"&&(_=!1),this._E=e,this._V=t,this._S=a,this._XG=n,this._re_encrypted=_;}get_E(){return this._E}get_V(){return this._V}get_S(){return this._S}get_XG(){return this._XG}set_re_encrypted(){this._re_encrypted=!0;}is_re_encrypted(){return this._re_encrypted}to_bytes(){var e=this.get_E().to_bytes(),t=this.get_V().to_bytes(),a=this.get_S().to_bytes(),n=[];return this.is_re_encrypted()&&this._XG&&(n=this._XG.to_bytes()),e.concat(t,a,n)}static from_bytes(e){var t=u.expected_byte_length(),a=c.expected_byte_length(),n=!1;if(e.length==3*a+t)n=!0;else if(e.length!=2*a+t)throw new Error("Invalid length of data.");var _=c.from_bytes(e.subarray(0,a)),o=c.from_bytes(e.subarray(a,2*a)),b=u.from_bytes(e.subarray(2*a,2*a+t)),d=void 0;return n&&(d=c.from_bytes(e.subarray(2*a+t,3*a+t))),new p(_,o,b,d,n)}};r(p,"Capsule");var z=class{constructor(e){this._scalar=e;let t=new k,a=new y(new c(t.generator().mul(e.valueOf())));this._public_key=a;}valueOf(){return this._scalar}get_public_key(){var e=new k;return new y(new c(e.generator().mul(this.valueOf().valueOf())))}to_bytes(){return this.valueOf().to_bytes()}static generate(e){var a=l()._curve.genKeyPair();return new z(new u(a.getPrivate()))}},m=z;r(m,"PrivateKey"),m.from_bytes=r(function(e){return new z(u.from_bytes(e))},"from_bytes");var y=class{constructor(e){this.pubKey=e;}valueOf(){return this.pubKey}to_bytes(){return this.valueOf().to_bytes()}static from_bytes(e){return new y(c.from_bytes(e))}};r(y,"PublicKey");var h=class{constructor(e,t){this._re_key=e,this._internal_public_key=t;}get_re_key(){return this._re_key}get_internal_public_key(){return this._internal_public_key}to_bytes(){var e=this.get_re_key().to_bytes(),t=this.get_internal_public_key().to_bytes();return e.concat(t)}static from_bytes(e){var t=u.expected_byte_length(),a=c.expected_byte_length();if(e.length!=a+t)throw new Error("Invalid length of data.");var n=u.from_bytes(e.subarray(0,t)),_=c.from_bytes(e.subarray(t,t+a));return new h(n,_)}};r(h,"ReEncryptionKey");var g=class{constructor(e,t){this._private_key=e,this._public_key=t;}get_public_key(){return this._public_key}get_private_key(){return this._private_key}static generate_key_pair(){var e=m.generate();return new g(e,e.get_public_key())}static from_private_key(e){let t=new m(new u(new L__default.default(e.startsWith("0x")?e.slice(2):e,"hex")));return new g(t,t.get_public_key())}};r(g,"KeyPair");function w(s){return Array.from(s,e=>("0"+(e&255).toString(16)).slice(-2)).join("")}r(w,"to_hex");function v(s){return Buffer.from(s,"hex")}r(v,"from_hex");function K(s){var e=v(E.SHA256(w(s.to_bytes())).toString());return new u(new L.BN(e))}r(K,"SHA256");function x(s){var e=v(E.SHA256(w(s[0].to_bytes())).toString()),t=new L.BN(e),a=new L.BN(1);return new u(t.add(a))}r(x,"hash_to_scalar");var V=class{static generate_key_pair(){return g.generate_key_pair()}static generate_re_encryption_key(e,t){var a=this.generate_key_pair(),n=a.get_private_key().valueOf(),_=a.get_public_key().valueOf(),o=t.valueOf(),b=[_,o,o.mul(n)],d=x(b),G=e.valueOf(),X=d.invm(),A=G.mul(X),C=new h(A,_);return C}static decapsulate(e,t){return e.is_re_encrypted()?this.decapsulate_re_encrypted(e,t):this.decapsulate_original(e,t)}static public_key_from_bytes(e){return y.from_bytes(e)}},i=V;r(i,"Proxy"),i.encapsulate=r(e=>{var t=V.generate_key_pair(),a=V.generate_key_pair(),n=t.get_private_key().valueOf(),_=a.get_private_key().valueOf(),o=t.get_public_key().valueOf(),b=a.get_public_key().valueOf(),d=[o,b],G=x(d),X=n.add(_.mul(G)),A=e.valueOf(),C=A.mul(n.add(_)),q=K(C),I=new p(o,b,X),P={capsule:I,symmetric_key:q};return P},"encapsulate"),i.decapsulate_original=r(function(e,t){var a=t.valueOf(),n=e.get_E().add(e.get_V()),_=n.mul(a),o=K(_);return o},"decapsulate_original"),i.re_encrypt_capsule=r(function(e,t){var a=e.get_E().mul(t.get_re_key()),n=e.get_V().mul(t.get_re_key()),_=e.get_S();return new p(a,n,_,t.get_internal_public_key(),!0)},"re_encrypt_capsule"),i.decapsulate_re_encrypted=r(function(e,t){var a=e.get_XG(),n=e.get_E(),_=e.get_V(),o=[a,t.get_public_key().valueOf(),a.mul(t.valueOf())],b=x(o),d=n.add(_).mul(b),G=K(d);return G},"decapsulate_re_encrypted"),i.private_key_from_bytes=r(function(e){return m.from_bytes(e)},"private_key_from_bytes"),i.re_encryption_key_from_bytes=r(function(e){return h.from_bytes(e)},"re_encryption_key_from_bytes"),i.capsule_from_bytes=r(function(e){return p.from_bytes(e)},"capsule_from_bytes");var N={iv:E__default.default.enc.Utf8.parse("0000000000000000"),mode:E__default.default.mode.CBC,padding:E__default.default.pad.Pkcs7};function Ge(s,e){let t=i.public_key_from_bytes(v(s));var a=i.encapsulate(t),n=w(a.symmetric_key.to_bytes()),_=E__default.default.enc.Utf8.parse(n),o=E__default.default.AES.encrypt(e,_,N);return {key:w(a.capsule.to_bytes()),cipher:o.toString()}}r(Ge,"encryptData");function Be(s,e){let t=i.private_key_from_bytes(v(s)),a=i.capsule_from_bytes(v(e.key));var n=i.decapsulate(a,t),_=E__default.default.enc.Utf8.parse(w(n.to_bytes())),o=E__default.default.AES.decrypt(e.cipher,_,N).toString(E__default.default.enc.Utf8);return o}r(Be,"decryptData");function Ke(s,e){let t=i.private_key_from_bytes(v(s)),a=i.public_key_from_bytes(v(e));var n=i.generate_re_encryption_key(t,a);return w(n.to_bytes())}r(Ke,"generateReEncrytionKey");function xe(s,e){let t=i.re_encryption_key_from_bytes(v(s)),a=i.capsule_from_bytes(v(e.key)),n=i.re_encrypt_capsule(a,t);e.key=w(n.to_bytes());}r(xe,"reEncryption");

exports.Capsule = p;
exports.Config = B;
exports.Curve = k;
exports.GroupElement = c;
exports.KeyPair = g;
exports.PrivateKey = m;
exports.Proxy = i;
exports.PublicKey = y;
exports.ReEncryptionKey = h;
exports.SHA256 = K;
exports.Scalar = u;
exports.decryptData = Be;
exports.default_curve = l;
exports.encryptData = Ge;
exports.from_hex = v;
exports.generateReEncrytionKey = Ke;
exports.hash_to_scalar = x;
exports.reEncryption = xe;
exports.to_hex = w;
